<!DOCTYPE html>
<html lang="vi" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Giỏ hàng - Gaming Shop</title>
</head>
<body>
    <div layout:fragment="content">
        
        <!-- Breadcrumb -->
        <section class="breadcrumb-section py-3 bg-light">
            <div class="container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                        <li class="breadcrumb-item active">Giỏ hàng</li>
                    </ol>
                </nav>
            </div>
        </section>
        
        <!-- Cart Section -->
        <section class="cart-section py-5">
            <div class="container">
                
                <!-- Page Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="fw-bold">
                            <i class="bi bi-cart-fill text-danger me-2"></i>
                            Giỏ hàng của bạn
                        </h2>
                        <p class="text-muted">
                            Bạn đang có <strong th:text="${cartCount}">0</strong> sản phẩm trong giỏ
                        </p>
                    </div>
                </div>
                
                <!-- Success/Error Messages -->
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- Cart Content -->
                <div th:if="${cartItems != null and !cartItems.isEmpty()}">
                    <div class="row g-4">
                        
                        <!-- Cart Items -->
                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 15%;">Hình ảnh</th>
                                                    <th style="width: 35%;">Sản phẩm</th>
                                                    <th style="width: 20%;">Đơn giá</th>
                                                    <th style="width: 15%;">Số lượng</th>
                                                    <th style="width: 15%;">Thành tiền</th>
                                                    <th style="width: 5%;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="item : ${cartItems}">
                                                    <!-- Image -->
                                                    <td>
                                                        <img th:src="${item.sanPham.hinhAnh != null ? '/images/products/' + item.sanPham.hinhAnh : 'https://via.placeholder.com/80'}" 
                                                             th:alt="${item.sanPham.tenSanPham}"
                                                             class="img-fluid rounded"
                                                             style="max-width: 80px;">
                                                    </td>
                                                    
                                                    <!-- Product Info -->
                                                    <td>
                                                        <h6 class="mb-1">
                                                            <a th:href="@{'/products/' + ${item.sanPham.slug}}" 
                                                               th:text="${item.sanPham.tenSanPham}"
                                                               class="text-decoration-none text-dark">
                                                                Product
                                                            </a>
                                                        </h6>
                                                        <small class="text-muted" th:if="${item.sanPham.hang != null}">
                                                            <i class="bi bi-tag-fill me-1"></i>
                                                            <span th:text="${item.sanPham.hang.tenHang}">Brand</span>
                                                        </small>
                                                    </td>
                                                    
                                                    <!-- Price -->
                                                    <td>
                                                        <div th:if="${item.sanPham.chietKhau != null and item.sanPham.chietKhau > 0}">
                                                            <strong class="text-danger">
                                                                [[${#numbers.formatInteger(item.sanPham.giaSauGiam, 0, 'COMMA')}]]₫
                                                            </strong>
                                                            <br>
                                                            <small class="text-muted text-decoration-line-through">
                                                                [[${#numbers.formatInteger(item.sanPham.giaSanPham, 0, 'COMMA')}]]₫
                                                            </small>
                                                        </div>
                                                        <strong th:unless="${item.sanPham.chietKhau != null and item.sanPham.chietKhau > 0}"
                                                                class="text-danger">
                                                            [[${#numbers.formatInteger(item.sanPham.giaSanPham, 0, 'COMMA')}]]₫
                                                        </strong>
                                                    </td>
                                                    
                                                    <!-- Quantity -->
                                                    <td>
                                                        <form th:action="@{'/cart/update/' + ${item.id}}" method="post" 
                                                              class="d-inline">
                                                            <div class="input-group input-group-sm" style="max-width: 120px;">
                                                                <button class="btn btn-outline-secondary" type="button"
                                                                        th:onclick="'updateQty(' + ${item.id} + ', -1)'">
                                                                    <i class="bi bi-dash"></i>
                                                                </button>
                                                                <input type="number" 
                                                                       class="form-control text-center" 
                                                                       th:id="'qty-' + ${item.id}"
                                                                       name="quantity"
                                                                       th:value="${item.soLuong}"
                                                                       min="1"
                                                                       th:max="${item.sanPham.tonKho}"
                                                                       onchange="this.form.submit()">
                                                                <button class="btn btn-outline-secondary" type="button"
                                                                        th:onclick="'updateQty(' + ${item.id} + ', 1)'">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </td>
                                                    
                                                    <!-- Subtotal -->
                                                    <td>
                                                        <strong class="text-danger">
                                                            [[${#numbers.formatInteger(item.sanPham.giaSauGiam * item.soLuong, 0, 'COMMA')}]]₫
                                                        </strong>
                                                    </td>
                                                    
                                                    <!-- Remove -->
                                                    <td>
                                                        <a th:href="@{'/cart/remove/' + ${item.id}}" 
                                                           class="btn btn-sm btn-outline-danger"
                                                           onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?')">
                                                            <i class="bi bi-trash"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cart Actions -->
                            <div class="d-flex justify-content-between mt-3">
                                <a href="/products" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Tiếp tục mua hàng
                                </a>
                                <a href="/cart/clear" class="btn btn-outline-danger"
                                   onclick="return confirm('Bạn có chắc muốn xóa toàn bộ giỏ hàng?')">
                                    <i class="bi bi-trash me-2"></i>Xóa toàn bộ
                                </a>
                            </div>
                        </div>
                        
                        <!-- Order Summary -->
                        <div class="col-lg-4">
                            <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-calculator me-2"></i>Thông tin đơn hàng
                                    </h5>
                                </div>
                                <div class="card-body">
                                    
                                    <!-- Subtotal -->
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>Tạm tính:</span>
                                        <strong th:text="${#numbers.formatInteger(total, 0, 'COMMA')} + '₫'">0₫</strong>
                                    </div>
                                    
                                    <!-- Shipping -->
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>Phí vận chuyển:</span>
                                        <strong class="text-success">Miễn phí</strong>
                                    </div>
                                    
                                    <hr>
                                    
                                    <!-- Total -->
                                    <div class="d-flex justify-content-between mb-4">
                                        <h5 class="mb-0">Tổng cộng:</h5>
                                        <h5 class="mb-0 text-danger" 
                                            th:text="${#numbers.formatInteger(total, 0, 'COMMA')} + '₫'">
                                            0₫
                                        </h5>
                                    </div>
                                    
                                    <!-- Checkout Button -->
                                    <a href="/checkout" class="btn btn-danger btn-lg w-100 mb-3">
                                        <i class="bi bi-credit-card me-2"></i>
                                        Tiến hành thanh toán
                                    </a>
                                    
                                    <!-- Benefits -->
                                    <div class="benefits mt-3">
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-shield-check text-success me-1"></i>
                                            Thanh toán an toàn & bảo mật
                                        </small>
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-truck text-primary me-1"></i>
                                            Giao hàng nhanh chóng
                                        </small>
                                        <small class="text-muted d-block">
                                            <i class="bi bi-arrow-clockwise text-warning me-1"></i>
                                            Đổi trả trong 7 ngày
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Empty Cart -->
                <div th:if="${cartItems == null or cartItems.isEmpty()}" 
                     class="text-center py-5">
                    <i class="bi bi-cart-x" style="font-size: 5rem; color: #ccc;"></i>
                    <h3 class="mt-4 mb-3">Giỏ hàng của bạn đang trống</h3>
                    <p class="text-muted mb-4">Hãy thêm sản phẩm vào giỏ hàng để tiếp tục mua sắm!</p>
                    <a href="/products" class="btn btn-danger btn-lg">
                        <i class="bi bi-bag-fill me-2"></i>Khám phá sản phẩm
                    </a>
                </div>
                
            </div>
        </section>
        
    </div>
    
    <!-- Custom Scripts -->
    <th:block layout:fragment="scripts">
        <script>
            function updateQty(cartId, change) {
                const input = document.getElementById('qty-' + cartId);
                let currentQty = parseInt(input.value);
                let newQty = currentQty + change;
                
                if (newQty >= 1 && newQty <= parseInt(input.max)) {
                    input.value = newQty;
                    input.form.submit();
                }
            }
        </script>
    </th:block>
</body>
</html>